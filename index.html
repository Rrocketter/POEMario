
<!DOCTYPE html>

<html>

<head>
  <title>POE Mario S3</title>
  <meta charset="utf-8">
  <style>
    * {
      margin: 0;
    }
    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    canvas {
      display: block;
    }
  </style>
</head>

<body>
<script src="https://kaboomjs.com/lib/0.5.0/kaboom.js"></script>
<script src="https://kaboomjs.com/lib/0.5.0/plugins/aseprite.js"></script>
<script src="https://kaboomjs.com/lib/0.5.0/plugins/pedit.js"></script>
<script src="https://kaboomjs.com/pub/legacy/kbmsprite.js"></script>

  <script>

kaboom({
  ...{"fullscreen":true,"width":240,"height":240,"scale":1,"startScene":"main","version":"0.5.0","clearColor":[0,0,0,1]},
  global: true,
  plugins: [ peditPlugin, asepritePlugin, kbmspritePlugin ],
});
    
loadSprite("block", "sprites/block.png");
loadSprite("blue-block", "sprites/blue-block.png");
loadSprite("blue-brick", "sprites/blue-brick.png");
loadSprite("blue-evil-shroom", "sprites/blue-evil-shroom.png");
loadSprite("blue-steel", "sprites/blue-steel.png");
loadSprite("blue-surprise", "sprites/blue-surprise.png");
loadSprite("brick", "sprites/brick.png");
loadSprite("coin", "sprites/coin.png");
loadSprite("evil-shroom-1", "sprites/evil-shroom-1.png");
loadSprite("mario-standing", "sprites/mario-standing.png");
loadSprite("mushroom", "sprites/mushroom.png");
loadSprite("pipe-left", "sprites/pipe-left.png");
loadSprite("pipe-right", "sprites/pipe-right.png");
loadSprite("pipe-top-left-side", "sprites/pipe-top-left-side.png");
loadSprite("pipe-top-right-side", "sprites/pipe-top-right-side.png");
loadSprite("question", "sprites/question.png");
loadSprite("unboxed", "sprites/unboxed.png");
scene("lose", (args = {}) => {
add([
  text(args.score),
  origin('center'),
  pos(width()/2, height()/2),
  scale(10)
])
});

    
scene("main", (args = {}) => {
const MOVE_SPEED = 120
const JUMP_FORCE = 360
const BIG_JUMP_FORCE = 550
let CURRENT_JUMP_FORCE = JUMP_FORCE
const ENEMY_SPEED = 20
const FALL_DEATH = 600

let isJumping = true
  
layers(['obj', 'ui'], 'obj')

const maps = [
  [
    '                              ',
    '                              ',
    '                              ',
    '                              ',
    '                              ',
    '    %   =*=%=                %',
    '                              ',
    '                      -+      ',
    '             ^   ^    ()      ',
    'xxxxxxxxxxxxxxxxxxxxxxxx    xx',
  ], [
    '                               ',
    '£                              £',
    '£                              £',
    '£        @@@@@      s          £',
    '£                 s s s        £',
    '£               s s s s s    -+£',
    '£      !      s s s s s s    ()£',
    'zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz',
  ], [
    '                   %          ',
    '                              ',
    '                              ',
    '                              ',
    '         *=      £  s         ',
    '                 £  s     -+  ',
    '      ^      !   £  s     ()  ',
    'zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz',
  ], [
    '                              ',
    '                              ',
    '                              ',
    '                              ',
    '                              ',
    '                             %',
    '           ==*                ',
    '                            -+',
    '          !!^   ^   ^ !     ()',
    'xxxxxxxxxxxxxxxxxxxxxxxx    xx',
  ], [
    '                             ',
    '£                           £',
    '£                           £',
    '£        @@@**              £',
    '£                   s       £',
    '£                   s     -+£',
    '£      !     ^ s ^  s   s ()£',
    'zzzzzzzzzzzzzzzzzzzzzzzzzzzzz',
  ],
]


const levelCfg = {
  width: 20,
  height: 20,
  '=' : [sprite('block'), solid()],
  'x' : [sprite('brick'), solid()],
  '$' : [sprite('coin'), 'coin'],
  '%' : [sprite('question'), 'coin-surprise', solid()],
  '*' : [sprite('question'), 'mushroom-surprise', solid()],   
  '}' : [sprite('unboxed'), solid()], 
  '(' : [sprite('pipe-left'), scale(0.5), solid()],
  ')' : [sprite('pipe-right'), scale(0.5), solid()], 
  '-' : [sprite('pipe-top-left-side'), scale(0.5), solid(), 'pipe'],
  '+' : [sprite('pipe-top-right-side'), scale(0.5), solid(), 'pipe'], 
  '^' : [sprite('evil-shroom-1'), solid(), 'dangerous'], 
  '#' : [sprite('mushroom'), 'mushroom', body()], 
  '£' : [sprite('blue-brick'), solid(),scale(0.5)],
  'z' : [sprite('blue-block'), solid(), scale(0.5)], 
  '@' : [sprite('blue-surprise'), solid(), scale(0.5), 'coin-surprise'],
  '!' : [sprite('blue-evil-shroom'), 'dangerous', scale(0.5)],
  's' : [sprite('blue-steel'), solid(), scale(0.5)],  
}

const levelIndex = args.level ?? 0 
const gameLevel = addLevel(maps[levelIndex], levelCfg)

const scoreGlobal = args.score ?? 0
const scoreLabel = add([
  text(scoreGlobal),
  pos(30,6),
  layer('ui'),
  {
    value: scoreGlobal,
  }
])

add([text('level ' + parseInt(levelIndex + 1)), pos(40, 6)])


let tipNumber = 0
function RecycleTip() {
 
  switch(tipNumber) {
    case 0: 
      dangerousRecyclingTextObj = drawDangerousText('Companies in the US use credits \nlike these (Carbon Credits) to help protect the environment', 50)
      console.log("case 0")
      tipNumber++
      break;
    case 1: 
      dangerousRecyclingTextObj = drawDangerousText('Recycling is important! \nAround $100 Billion is lost in the economy from single use plastic bags.', 50);
      console.log("case 1")
      tipNumber++
      break;
    case 2: 
      dangerousRecyclingTextObj = drawDangerousText('Despite this, plastic recycling rates are far lower than of other materials', 50)
      console.log("case 2")
      tipNumber++
      break;
    case 3: 
      dangerousRecyclingTextObj = drawDangerousText('There are 7 common groups of plastic: \n PET, HDPE, PVC/Vinyl, LDPE, PP, PS/Styrofoam, and Other', 50)
      console.log("case 3")
      tipNumber++
      break;
    case 4:
      dangerousRecyclingTextObj = drawDangerousText('Recycling rates differ upon the type of plastic being recycled', 50)
      console.log("case 4")
      tipNumber++
      break; 
    case 5: 
      dangerousRecyclingTextObj = drawDangerousText('PET and HDPE have the highest recycling\n Materials such as PS are not often recycled', 50)
      tipNumber++
      break;
    case 6:
      dangerousRecyclingTextObj = drawDangerousText('In addition, recycling rates vary vastly between countries.\n Poorer countries are less likely to recycle materials than richer ones', 50)
      tipNumber++
      break;
    case 7: 
      dangerousRecyclingTextObj = drawDangerousText('The first step of the recycling process is to sort the material', 50)
      tipNumber++
      break;
    case 8:
      dangerousRecyclingTextObj = drawDangerousText('Most sorting is done automatically, with a manual inspection to ensure quality', 50)
      tipNumber++
      break;
    case 9:
      dangerousRecyclingTextObj = drawDangerousText('After sorting, most plastics are then melted to be created into different materials', 50)
      tipNumber++
      break; 
    case 10:
      dangerousRecyclingTextObj = drawDangerousText('The melted plastics are then moulded to form different products', 50)
      tipNumber++
      break;  
    case 11:
      dangerousRecyclingTextObj = drawDangerousText('A list of plastic items created include: \n Bags, E-readers, drink bottles, flower pots, and more', 50)
      tipNumber++
      break;  
    case 12: 
      dangerousRecyclingTextObj = drawDangerousText('Unfortunately, only a small percentage of plastics end up being recycled', 50)
      tipNumber++
      break;
    case 13: 
      dangerousRecyclingTextObj = drawDangerousText('In addition, the recycling process may end up damaging the ecosystem, \n in the form of harmful microplastics that leech into water', 50)
      tipNumber++
      break;
    case 14:
      dangerousRecyclingTextObj = drawDangerousText('New technologies aim to combat these effects, and improve plastic recycling efficiency overall')
      tipNumber++ 
      break;  
    case 15: 
      dangerousRecyclingTextObj = drawDangerousText ('Examples of emerging technologies include AI sorting systems \n and biodegradable plastics')
      tipNumber++
      break;

  }
  
  
 
}


function big() {
  let timer = 0
  let isBig = false
  return {
    update() {
      if (isBig) {
        timer -=dt()
        if (timer <=0) {
          this.smallify()
        }
      }
    },
    isBig() {
      return isBig
    },
    smallify() {
      this.scale = vec2(1)
      timer = 0
      isBig = false
      CURRENT_JUMP_FORCE = JUMP_FORCE
    },
    biggify(time) {
      this.scale = vec2(2)
      timer = time
      isBig = true
      CURRENT_JUMP_FORCE = BIG_JUMP_FORCE
    }
  }
}

let existingText = null
function drawDangerousText(name, pxlocal) {
  if(existingText)
    destroy(existingText)

    const textObj = add([
      text(name),
      pos(pxlocal, 0),
      origin('center'),
      color(1, 1, 1),
    ]);
  

  existingText = textObj

  return textObj;
}

const player = add([
  sprite('mario-standing'),
  pos(30,0),
  body(),
  big(),
  origin('bot')
])
   
let dangerousRecyclingTime = 0;
let dangerousRecyclingTextObj = null;
let isTextDestroyed = false

player.collides('dangerous', (d) => {
  if(isJumping) {
    
    destroy(d)
    
     RecycleTip();
    
  } else {
     go('lose', { score: scoreLabel.value}) 
  }
})

player.action(() => {
  camPos(player.pos)
  if (player.pos.y >= FALL_DEATH) {
    go('lose', { score: scoreLabel.value })
  }
})

keyDown('left', () => {
  player.move(-MOVE_SPEED, 0)
})

keyDown('right', () => {
  player.move(MOVE_SPEED, 0)
})

  player.action(() => {
    if(player.grounded()) {
      isJumping = false
    }
  })

  keyPress('space', () => {
    if (player.grounded()) {
      isJumping = true
      player.jump(CURRENT_JUMP_FORCE)
    }
  })

  keyPress('up', () => {
    if (player.grounded()) {
      isJumping = true
      player.jump(CURRENT_JUMP_FORCE)
    }
  })

player.on('headbump', (obj) => {
  if(obj.is('coin-surprise')) {
    gameLevel.spawn('$', obj.gridPos.sub(0,1))
    destroy(obj)
    gameLevel.spawn('}', obj.gridPos.sub(0,0))
    RecycleTip();
  }
  if(obj.is('mushroom-surprise')) {
    gameLevel.spawn('#', obj.gridPos.sub(0,1))
    destroy(obj)
    gameLevel.spawn('}', obj.gridPos.sub(0,0))
    dangerousRecyclingTextObj = drawDangerousText('With a bigger initiative and \nmore people, piece by piece, the environment will be become cleaner everyday!', 50);
  }
})

action('mushroom', (m) => {
  m.move(20, 0)
})

player.collides('mushroom', (m) => {
  player.biggify(6)
  destroy(m)
})

player.collides('coin', (c) => {
  scoreLabel.value++
  scoreLabel.text = scoreLabel.value
  destroy(c)
})

action('dangerous', (d) => {
  d.move(-ENEMY_SPEED,0)
})

player.collides('pipe', () => {
  keyPress('down', () => {
    go('main', {
      level: (levelIndex + 1) % maps.length,
      score: scoreLabel.value
    })
  })
})


});
    
start("main");

  </script>
</body>
</html>